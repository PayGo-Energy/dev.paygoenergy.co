<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.d70697ed10dca6435bb8.css">@import url(https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap);@import url(https://fonts.googleapis.com/icon?family=Material+Icons);body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}code{font-family:source-code-pro,Menlo,Monaco,Consolas,Courier New,monospace}.content-container{padding:2em;margin-bottom:2em}</style><meta name="generator" content="Gatsby 2.10.4"/><title data-react-helmet="true">SailsJS transactions and exits | PayGo Energy Dev Team</title><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link as="script" rel="preload" href="/styles-f907142474616c65419d.js"/><link as="script" rel="preload" href="/component---src-pages-blog-2019-06-20-sailsjs-transactions-and-exits-index-js-c91935e46dbb871528ba.js"/><link as="script" rel="preload" href="/2-3bf0ec90dbd38abd1022.js"/><link as="script" rel="preload" href="/1-ba61c470b01978e180bc.js"/><link as="script" rel="preload" href="/app-5befd302e65070181bb9.js"/><link as="script" rel="preload" href="/webpack-runtime-f54bed28e5bbff5d5cd5.js"/><link as="fetch" rel="preload" href="/page-data/blog/2019-06-20-sailsjs-transactions-and-exits/page-data.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><header class="MuiPaper-root MuiPaper-elevation4 MuiAppBar-root MuiAppBar-positionStatic MuiAppBar-colorDefault"><div class="MuiToolbar-root MuiToolbar-regular jss2 MuiToolbar-gutters"><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-colorInherit MuiIconButton-edgeStart" tabindex="0" type="button" aria-label="Open drawer"><span class="MuiIconButton-label"><svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true" role="presentation"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></span></button><a href="/"><img alt="PayGo Energy" src="/logo.svg" class="jss1"/></a><h6 class="MuiTypography-root jss3 MuiTypography-h6 MuiTypography-colorInherit">SailsJS transactions and exits</h6></div></header><div class="MuiContainer-root MuiContainer-maxWidthLg"><h1><a href="/blog/2019-06-20-sailsjs-transactions-and-exits">SailsJS Transaction Behaviour</a></h1><p>SailsJS <a href="https://sailsjs.com/documentation/reference/waterline-orm/datastores/transaction">supports transactions</a> when using the <a href="https://github.com/balderdashy/sails-postgresql"><code>sails-postgresql</code></a> and <a href="https://github.com/balderdashy/sails-mysql"><code>sails-mysql</code></a> datastore adapters.</p><p>I only have experience with <code>sails-postgresql</code>, so unless otherwise mentioned, code below is in reference to that.</p><p>At <a href="https://dev.paygoenergy.co">PayGo</a> we&#x27;ve had a few surprises about how sails transactions act from within controllers.  In hindsight some of these are obvious, but others are a little more subtle.</p><h1>Rule: updating a row locks it until the transaction completes</h1><p>If you have two competing transactions updating the same row, one will be blocked until the other has completed.</p><h2>Example</h2><p>You have a simple model:</p><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#7C7C7C">// api/models/Thing.js</span>
module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  attributes<span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token spread" style="color:#EDEDED">...</span>
    lastUpdatedBy<span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#c5c8c6">{</span> type<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#A8FF60">&#x27;string&#x27;</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
    <span class="token spread" style="color:#EDEDED">...</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span></code></pre><p>And two controllers:</p><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#7C7C7C">// api/controllers/quick.js</span>
module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  <span class="token function-variable" style="color:#DAD085">fn</span><span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">inputs<span class="token" style="color:#c5c8c6">,</span> exits</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token" style="color:#96CBFE">await</span> sails
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">getDatastore</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span>
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">transaction</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#96CBFE">async</span> <span class="token parameter">db</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#c5c8c6">{</span>
          <span class="token" style="color:#96CBFE">await</span> <span class="token maybe-class-name">Thing</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">update</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#FF73FD">1</span><span class="token" style="color:#c5c8c6">)</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">set</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">{</span> lastUpdatedBy<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#A8FF60">&#x27;quick&#x27;</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
        <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span></code></pre><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#7C7C7C">// api/controllers/slow.js</span>
module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  <span class="token function-variable" style="color:#DAD085">fn</span><span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">inputs<span class="token" style="color:#c5c8c6">,</span> exits</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token" style="color:#96CBFE">await</span> sails
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">getDatastore</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span>
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">transaction</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#96CBFE">async</span> <span class="token parameter">db</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#c5c8c6">{</span>
          <span class="token" style="color:#96CBFE">await</span> <span class="token maybe-class-name">Thing</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">update</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#FF73FD">1</span><span class="token" style="color:#c5c8c6">)</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">set</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">{</span> lastUpdatedBy<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#A8FF60">&#x27;slow&#x27;</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
          <span class="token" style="color:#96CBFE">await</span> <span class="token" style="color:#DAD085">sleep</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#FF73FD">10000</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
        <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span>

<span class="token" style="color:#96CBFE">const</span> <span class="token function-variable" style="color:#DAD085">sleep</span> <span class="token" style="color:#EDEDED">=</span> <span class="token parameter">millis</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#96CBFE">new</span> <span class="token" style="color:#FFFFB6;text-decoration:underline">Promise</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">resolve</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#DAD085">setTimeout</span><span class="token" style="color:#c5c8c6">(</span>resolve<span class="token" style="color:#c5c8c6">,</span> millis<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span></code></pre><p>If you now call:</p><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">time curl http<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#EDEDED">/</span><span class="token" style="color:#EDEDED">/</span>localhost<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#FF73FD">1337</span><span class="token" style="color:#EDEDED">/</span>slow <span class="token" style="color:#EDEDED">&amp;</span>
sleep <span class="token" style="color:#FF73FD">1</span> <span class="token" style="color:#EDEDED">&amp;&amp;</span> time curl http<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#EDEDED">/</span><span class="token" style="color:#EDEDED">/</span>localhost<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#FF73FD">1337</span><span class="token" style="color:#EDEDED">/</span>quick</code></pre><p>You will see that the call to <code>/quick</code> waits until the call to <code>/slow</code> has completed before it returns.</p><h1>Rule: never update a row without locking, unless your update is atomic</h1><p>Modifying our slow/quick example from above so that the slow controller now sleeps <em>before</em> updating the db, using the standard sails locking strategy:</p><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#7C7C7C">// api/models/Thing.js</span>
module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  attributes<span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token spread" style="color:#EDEDED">...</span>
    counter<span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#c5c8c6">{</span> type<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#A8FF60">&#x27;number&#x27;</span><span class="token" style="color:#c5c8c6">,</span> columnType<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#A8FF60">&#x27;integer&#x27;</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
    <span class="token spread" style="color:#EDEDED">...</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span></code></pre><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#7C7C7C">// api/controllers/current.js</span>
module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  <span class="token function-variable" style="color:#DAD085">fn</span><span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token" style="color:#96CBFE">const</span> t <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#96CBFE">await</span> <span class="token maybe-class-name">Thing</span><span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">findOne</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#FF73FD">1</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
    <span class="token" style="color:#96CBFE">return</span> exits<span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">success</span><span class="token" style="color:#c5c8c6">(</span>t<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">counter</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span></code></pre><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#7C7C7C">// api/controllers/quick.js</span>
module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  <span class="token function-variable" style="color:#DAD085">fn</span><span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">inputs<span class="token" style="color:#c5c8c6">,</span> exits</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token" style="color:#96CBFE">await</span> sails
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">getDatastore</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span>
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">transaction</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#96CBFE">async</span> <span class="token parameter">db</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#c5c8c6">{</span>
          <span class="token" style="color:#96CBFE">const</span> t <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#96CBFE">await</span> <span class="token maybe-class-name">Thing</span><span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">findOne</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#FF73FD">1</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">usingConnection</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
          <span class="token" style="color:#96CBFE">await</span> <span class="token maybe-class-name">Thing</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">update</span><span class="token" style="color:#c5c8c6">(</span>t<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">id</span><span class="token" style="color:#c5c8c6">)</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">set</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">{</span> counter<span class="token" style="color:#c5c8c6">:</span>t<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">counter</span><span class="token" style="color:#EDEDED">+</span><span class="token" style="color:#FF73FD">10</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">usingConnection</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
        <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span></code></pre><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#7C7C7C">// api/controllers/slow.js</span>
module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  <span class="token function-variable" style="color:#DAD085">fn</span><span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">inputs<span class="token" style="color:#c5c8c6">,</span> exits</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token" style="color:#96CBFE">await</span> sails
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">getDatastore</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span>
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">transaction</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#96CBFE">async</span> <span class="token parameter">db</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#c5c8c6">{</span>
          <span class="token" style="color:#96CBFE">const</span> t <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#96CBFE">await</span> <span class="token maybe-class-name">Thing</span><span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">findOne</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#FF73FD">1</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">usingConnection</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
          <span class="token" style="color:#96CBFE">await</span> <span class="token" style="color:#DAD085">sleep</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#FF73FD">10000</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
          <span class="token" style="color:#96CBFE">await</span> <span class="token maybe-class-name">Thing</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">update</span><span class="token" style="color:#c5c8c6">(</span>t<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">id</span><span class="token" style="color:#c5c8c6">)</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">set</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">{</span> counter<span class="token" style="color:#c5c8c6">:</span>t<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">counter</span><span class="token" style="color:#EDEDED">+</span><span class="token" style="color:#FF73FD">3</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">usingConnection</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
        <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span>

<span class="token" style="color:#96CBFE">const</span> <span class="token function-variable" style="color:#DAD085">sleep</span> <span class="token" style="color:#EDEDED">=</span> <span class="token parameter">millis</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#96CBFE">new</span> <span class="token" style="color:#FFFFB6;text-decoration:underline">Promise</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">resolve</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#DAD085">setTimeout</span><span class="token" style="color:#c5c8c6">(</span>resolve<span class="token" style="color:#c5c8c6">,</span> millis<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span></code></pre><p>Assuming an initial value for <code>t.counter</code> of zero, if you now call:</p><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">curl http<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#EDEDED">/</span><span class="token" style="color:#EDEDED">/</span>localhost<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#FF73FD">1337</span><span class="token" style="color:#EDEDED">/</span>current
curl <span class="token" style="color:#EDEDED">-</span>q http<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#EDEDED">/</span><span class="token" style="color:#EDEDED">/</span>localhost<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#FF73FD">1337</span><span class="token" style="color:#EDEDED">/</span>slow <span class="token" style="color:#EDEDED">&amp;</span>
sleep <span class="token" style="color:#FF73FD">1</span>
curl <span class="token" style="color:#EDEDED">-</span>q http<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#EDEDED">/</span><span class="token" style="color:#EDEDED">/</span>localhost<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#FF73FD">1337</span><span class="token" style="color:#EDEDED">/</span>quick
curl <span class="token" style="color:#EDEDED">-</span>q http<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#EDEDED">/</span><span class="token" style="color:#EDEDED">/</span>localhost<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#FF73FD">1337</span><span class="token" style="color:#EDEDED">/</span>current
sleep <span class="token" style="color:#FF73FD">10</span>
curl http<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#EDEDED">/</span><span class="token" style="color:#EDEDED">/</span>localhost<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#FF73FD">1337</span><span class="token" style="color:#EDEDED">/</span>current</code></pre><p>You will see:</p><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#FF73FD">0</span>
<span class="token" style="color:#FF73FD">10</span>
<span class="token" style="color:#FF73FD">3</span></code></pre><h2>Problem</h2><p>Although both controllers are reading <code>Thing #1</code>, incrementing its counter, and writing it within a transaction, their transactions overlap and cause inconsistent values to be written to the database.</p><p>Interestingly, in this case there is actually no value to calling <code>findOne()</code> within the transaction - the <code>usingConnection(db)</code> appears to do nothing.</p><h2>Solution 1: single SQL queries</h2><p>To achieve consistent updates for these rows, one option is to use proper SQL to perform our updates.  The <code>quick</code> and <code>slow</code> controllers can be rewritten to increment the <code>counter</code> column in a single query:</p><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#7C7C7C">// api/controllers/quick.js</span>
module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  <span class="token function-variable" style="color:#DAD085">fn</span><span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">inputs<span class="token" style="color:#c5c8c6">,</span> exits</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token" style="color:#96CBFE">await</span> sails
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">getDatastore</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span>
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">sendNativeQuery</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#A8FF60">&#x27;UPDATE thing SET counter=counter+10 WHERE id=$1&#x27;</span><span class="token" style="color:#c5c8c6">,</span> <span class="token" style="color:#c5c8c6">[</span> <span class="token" style="color:#FF73FD">1</span> <span class="token" style="color:#c5c8c6">]</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span></code></pre><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#7C7C7C">// api/controllers/slow.js</span>
module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  <span class="token function-variable" style="color:#DAD085">fn</span><span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">inputs<span class="token" style="color:#c5c8c6">,</span> exits</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token" style="color:#96CBFE">await</span> <span class="token" style="color:#DAD085">sleep</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#FF73FD">10000</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
    <span class="token" style="color:#96CBFE">await</span> sails
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">getDatastore</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span>
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">sendNativeQuery</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#A8FF60">&#x27;UPDATE thing SET counter=counter+3 WHERE id=$1&#x27;</span><span class="token" style="color:#c5c8c6">,</span> <span class="token" style="color:#c5c8c6">[</span> <span class="token" style="color:#FF73FD">1</span> <span class="token" style="color:#c5c8c6">]</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span>

<span class="token" style="color:#96CBFE">const</span> <span class="token function-variable" style="color:#DAD085">sleep</span> <span class="token" style="color:#EDEDED">=</span> <span class="token parameter">millis</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#96CBFE">new</span> <span class="token" style="color:#FFFFB6;text-decoration:underline">Promise</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">resolve</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#DAD085">setTimeout</span><span class="token" style="color:#c5c8c6">(</span>resolve<span class="token" style="color:#c5c8c6">,</span> millis<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span></code></pre><h2>Solution 2: optimistic locking</h2><p>Optimistic locking is a lock that is only checked at write-time.  If there have been changes to a row between reading and writing, the write operation fails.</p><p>Note that if updating more than one row in a single operation, you should still be using transactions.  At this point you are implicitly using both optimistic <em>and</em> pessimistic locking.</p><h3>With implicit versioning</h3><p>Optimistic locking can be achieved by including the full details of the selected object when requesting an update, e.g.:</p><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token maybe-class-name">Thing</span> t <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#96CBFE">await</span> <span class="token maybe-class-name">Thing</span><span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">find</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#FF73FD">1</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
<span class="token" style="color:#96CBFE">const</span> updatedRowCount <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#96CBFE">await</span> <span class="token maybe-class-name">Thing</span>
    <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">update</span><span class="token" style="color:#c5c8c6">(</span>t<span class="token" style="color:#c5c8c6">)</span>
    <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">set</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">{</span> some_property<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#A8FF60">&#x27;new-value&#x27;</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
<span class="token" style="color:#96CBFE">if</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#EDEDED">!</span>updatedRowCount<span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#96CBFE">throw</span> <span class="token" style="color:#96CBFE">new</span> <span class="token" style="color:#FFFFB6;text-decoration:underline">Error</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#A8FF60">&#x27;Update failed for Thing #1&#x27;</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span></code></pre><h3>With explicit versioning</h3><p>Another approach is to manually track your own <code>version</code> column on each database model, and check it whenever doing an update:</p><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#7C7C7C">// api/models/Thing.js</span>
module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  attributes<span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token spread" style="color:#EDEDED">...</span>
    version<span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#c5c8c6">{</span> type<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#A8FF60">&#x27;number&#x27;</span><span class="token" style="color:#c5c8c6">,</span> columnType<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#A8FF60">&#x27;integer&#x27;</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
    <span class="token spread" style="color:#EDEDED">...</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span></code></pre><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#7C7C7C">// api/controllers/quick.js</span>
<span class="token" style="color:#96CBFE">const</span> optimisticUpdate <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#DAD085">require</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#A8FF60">&#x27;../../utils/optimistic-update&#x27;</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  <span class="token function-variable" style="color:#DAD085">fn</span><span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">inputs<span class="token" style="color:#c5c8c6">,</span> exits</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token" style="color:#96CBFE">await</span> sails
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">getDatastore</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span>
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">transaction</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#96CBFE">async</span> <span class="token parameter">db</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#c5c8c6">{</span>
          <span class="token" style="color:#96CBFE">const</span> t <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#96CBFE">await</span> <span class="token maybe-class-name">Thing</span><span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">findOne</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#FF73FD">1</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">usingConnection</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
          <span class="token" style="color:#96CBFE">await</span> <span class="token" style="color:#DAD085">optimisticUpdate</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">,</span> <span class="token maybe-class-name">Thing</span><span class="token" style="color:#c5c8c6">,</span> t<span class="token" style="color:#c5c8c6">,</span> <span class="token" style="color:#c5c8c6">{</span> counter<span class="token" style="color:#c5c8c6">:</span>t<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">counter</span><span class="token" style="color:#EDEDED">+</span><span class="token" style="color:#FF73FD">10</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
        <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span></code></pre><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#7C7C7C">// api/controllers/slow.js</span>
module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  <span class="token function-variable" style="color:#DAD085">fn</span><span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">inputs<span class="token" style="color:#c5c8c6">,</span> exits</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token" style="color:#96CBFE">await</span> sails
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">getDatastore</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span>
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">transaction</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#96CBFE">async</span> <span class="token parameter">db</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#c5c8c6">{</span>
          <span class="token" style="color:#96CBFE">const</span> t <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#96CBFE">await</span> <span class="token maybe-class-name">Thing</span><span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">findOne</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#FF73FD">1</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">usingConnection</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
          <span class="token" style="color:#96CBFE">await</span> <span class="token" style="color:#DAD085">sleep</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#FF73FD">10000</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
          <span class="token" style="color:#96CBFE">await</span> <span class="token" style="color:#DAD085">optimisticUpdate</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">,</span> <span class="token maybe-class-name">Thing</span><span class="token" style="color:#c5c8c6">,</span> t<span class="token" style="color:#c5c8c6">,</span> <span class="token" style="color:#c5c8c6">{</span> counter<span class="token" style="color:#c5c8c6">:</span>t<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">counter</span><span class="token" style="color:#EDEDED">+</span><span class="token" style="color:#FF73FD">3</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
        <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span>
<span class="token spread" style="color:#EDEDED">...</span></code></pre><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#7C7C7C">// utils/optimistic-update.js</span>
module<span class="token" style="color:#c5c8c6">.</span><span class="token method-variable function-variable method property-access" style="color:#DAD085">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">db<span class="token" style="color:#c5c8c6">,</span> <span class="token maybe-class-name">Model</span><span class="token" style="color:#c5c8c6">,</span> e<span class="token" style="color:#c5c8c6">,</span> update</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
  <span class="token" style="color:#96CBFE">const</span> updated <span class="token" style="color:#EDEDED">=</span> <span class="token maybe-class-name">Model</span>
      <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">updateOne</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">{</span> id<span class="token" style="color:#c5c8c6">:</span>e<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">id</span><span class="token" style="color:#c5c8c6">,</span> version<span class="token" style="color:#c5c8c6">:</span>e<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">version</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span>
      <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">set</span><span class="token" style="color:#c5c8c6">(</span>update<span class="token" style="color:#c5c8c6">)</span>
      <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">usingConnection</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>

  <span class="token" style="color:#96CBFE">if</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#EDEDED">!</span>updated<span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#96CBFE">throw</span> <span class="token" style="color:#96CBFE">new</span> <span class="token" style="color:#FFFFB6;text-decoration:underline">Error</span><span class="token" style="color:#c5c8c6">(</span><span class="token template-string"><span class="token" style="color:#A8FF60">`</span><span class="token interpolation"><span class="token interpolation-punctuation" style="color:#c5c8c6">${</span><span class="token maybe-class-name">Model</span><span class="token" style="color:#c5c8c6">.</span><span class="token property-access">globalId</span><span class="token interpolation-punctuation" style="color:#c5c8c6">}</span></span><span class="token" style="color:#A8FF60">#</span><span class="token interpolation"><span class="token interpolation-punctuation" style="color:#c5c8c6">${</span>e<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">id</span><span class="token interpolation-punctuation" style="color:#c5c8c6">}</span></span><span class="token" style="color:#A8FF60"> has changed version since last read (expected v</span><span class="token interpolation"><span class="token interpolation-punctuation" style="color:#c5c8c6">${</span>e<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">version</span><span class="token interpolation-punctuation" style="color:#c5c8c6">}</span></span><span class="token" style="color:#A8FF60">)!`</span></span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>

  <span class="token" style="color:#96CBFE">return</span> updated<span class="token" style="color:#c5c8c6">;</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span>
<span class="token spread" style="color:#EDEDED">...</span></code></pre><p>As above, in this case there is no value to calling <code>findOne()</code> within the transaction - the <code>usingConnection(db)</code> appears to do nothing.</p><p><code>optimisticUpdate()</code> could also be added to each model&#x27;s API, e.g. in <code>config/bootstrap.js</code>:</p><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#7C7C7C">// config/bootstrap.js</span>
module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  <span class="token spread" style="color:#EDEDED">...</span>
  <span class="token known-class-name" style="color:#FFFFB6;text-decoration:underline">Object</span><span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">values</span><span class="token" style="color:#c5c8c6">(</span>sails<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">models</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">forEach</span><span class="token" style="color:#c5c8c6">(</span>addOptimisticUpdate<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
  <span class="token spread" style="color:#EDEDED">...</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span>

<span class="token" style="color:#96CBFE">function</span> <span class="token" style="color:#DAD085">addOptimisticUpdate</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter"><span class="token maybe-class-name">Model</span></span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
  <span class="token maybe-class-name">Model</span><span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">optimisticUpdate</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">db<span class="token" style="color:#c5c8c6">,</span> e<span class="token" style="color:#c5c8c6">,</span> update</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token" style="color:#96CBFE">const</span> updated <span class="token" style="color:#EDEDED">=</span> <span class="token maybe-class-name">Model</span>
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">updateOne</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">{</span> id<span class="token" style="color:#c5c8c6">:</span>e<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">id</span><span class="token" style="color:#c5c8c6">,</span> version<span class="token" style="color:#c5c8c6">:</span>e<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">version</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span>
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">set</span><span class="token" style="color:#c5c8c6">(</span>update<span class="token" style="color:#c5c8c6">)</span>
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">usingConnection</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>

    <span class="token" style="color:#96CBFE">if</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#EDEDED">!</span>updated<span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#96CBFE">throw</span> <span class="token" style="color:#96CBFE">new</span> <span class="token" style="color:#FFFFB6;text-decoration:underline">Error</span><span class="token" style="color:#c5c8c6">(</span><span class="token template-string"><span class="token" style="color:#A8FF60">`</span><span class="token interpolation"><span class="token interpolation-punctuation" style="color:#c5c8c6">${</span><span class="token maybe-class-name">Model</span><span class="token" style="color:#c5c8c6">.</span><span class="token property-access">globalId</span><span class="token interpolation-punctuation" style="color:#c5c8c6">}</span></span><span class="token" style="color:#A8FF60">#</span><span class="token interpolation"><span class="token interpolation-punctuation" style="color:#c5c8c6">${</span>e<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">id</span><span class="token interpolation-punctuation" style="color:#c5c8c6">}</span></span><span class="token" style="color:#A8FF60"> has changed version since last read (expected v</span><span class="token interpolation"><span class="token interpolation-punctuation" style="color:#c5c8c6">${</span>e<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">version</span><span class="token interpolation-punctuation" style="color:#c5c8c6">}</span></span><span class="token" style="color:#A8FF60">)!`</span></span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>

    <span class="token" style="color:#96CBFE">return</span> updated<span class="token" style="color:#c5c8c6">;</span>
  <span class="token" style="color:#c5c8c6">}</span>
<span class="token" style="color:#c5c8c6">}</span></code></pre><h2>Solution 3: pessimistic locking</h2><p>This option does not require changes to the data model.  It leaves lock handling to PostgreSQL, which is convenient from an application developer&#x27;s point of view.  However, there may be performance implications relating to keeping database connections open for longer, and transactions can still fail when competing transactions attempt to make concurrent updates to the same database rows.  In the following implementation, it is also more error-prone if you pass complicated criteria to <code>find()</code> or <code>findOne()</code>, or non-standard mappings between column names and sails <code>attributes</code>.  It takes advantage of PostgreSQL&#x27;s <a href="https://www.postgresql.org/docs/9.5/sql-select.html"><code>SELECT ... FOR UPDATE</code> syntax</a>.</p><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#7C7C7C">// api/controllers/quick.js</span>
<span class="token" style="color:#96CBFE">const</span> findOneForUpdate <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#DAD085">require</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#A8FF60">&#x27;../../utils/find-one-for-update&#x27;</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>

module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  <span class="token function-variable" style="color:#DAD085">fn</span><span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">inputs<span class="token" style="color:#c5c8c6">,</span> exits</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token" style="color:#96CBFE">await</span> sails
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">getDatastore</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span>
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">transaction</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#96CBFE">async</span> <span class="token parameter">db</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#c5c8c6">{</span>
          <span class="token" style="color:#96CBFE">const</span> t <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#96CBFE">await</span> <span class="token" style="color:#DAD085">findOneForUpdate</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">,</span> <span class="token maybe-class-name">Thing</span><span class="token" style="color:#c5c8c6">,</span> <span class="token" style="color:#FF73FD">1</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
          <span class="token" style="color:#96CBFE">await</span> <span class="token maybe-class-name">Thing</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">update</span><span class="token" style="color:#c5c8c6">(</span>t<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">id</span><span class="token" style="color:#c5c8c6">)</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">set</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">{</span> counter<span class="token" style="color:#c5c8c6">:</span>t<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">counter</span><span class="token" style="color:#EDEDED">+</span><span class="token" style="color:#FF73FD">10</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">usingConnection</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
        <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span></code></pre><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#7C7C7C">// api/controllers/slow.js</span>
<span class="token" style="color:#96CBFE">const</span> findOneForUpdate <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#DAD085">require</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#A8FF60">&#x27;../../utils/find-one-for-update&#x27;</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>

module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  <span class="token function-variable" style="color:#DAD085">fn</span><span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">inputs<span class="token" style="color:#c5c8c6">,</span> exits</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token" style="color:#96CBFE">await</span> sails
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">getDatastore</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span>
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">transaction</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#96CBFE">async</span> <span class="token parameter">db</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#c5c8c6">{</span>
          <span class="token" style="color:#96CBFE">const</span> t <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#96CBFE">await</span> <span class="token" style="color:#DAD085">findOneForUpdate</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">,</span> <span class="token maybe-class-name">Thing</span><span class="token" style="color:#c5c8c6">,</span> <span class="token" style="color:#FF73FD">1</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
          <span class="token" style="color:#96CBFE">await</span> <span class="token" style="color:#DAD085">sleep</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#FF73FD">10000</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
          <span class="token" style="color:#96CBFE">await</span> <span class="token maybe-class-name">Thing</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">update</span><span class="token" style="color:#c5c8c6">(</span>t<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">id</span><span class="token" style="color:#c5c8c6">)</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">set</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">{</span> counter<span class="token" style="color:#c5c8c6">:</span>t<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">counter</span><span class="token" style="color:#EDEDED">+</span><span class="token" style="color:#FF73FD">10</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">usingConnection</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
        <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span>
<span class="token spread" style="color:#EDEDED">...</span></code></pre><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#7C7C7C">// utils/find-one-for-update.js</span>
module<span class="token" style="color:#c5c8c6">.</span><span class="token method-variable function-variable method property-access" style="color:#DAD085">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">db<span class="token" style="color:#c5c8c6">,</span> <span class="token maybe-class-name">Model</span><span class="token" style="color:#c5c8c6">,</span> id</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
  <span class="token" style="color:#96CBFE">return</span> sails
      <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">getDatastore</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span>
      <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">sendNativeQuery</span><span class="token" style="color:#c5c8c6">(</span><span class="token template-string"><span class="token" style="color:#A8FF60">`SELECT * FROM </span><span class="token interpolation"><span class="token interpolation-punctuation" style="color:#c5c8c6">${</span><span class="token maybe-class-name">Model</span><span class="token" style="color:#c5c8c6">.</span><span class="token property-access">tableName</span><span class="token interpolation-punctuation" style="color:#c5c8c6">}</span></span><span class="token" style="color:#A8FF60"> WHERE id=$1 FOR UPDATE`</span></span><span class="token" style="color:#c5c8c6">,</span> <span class="token" style="color:#c5c8c6">[</span> id <span class="token" style="color:#c5c8c6">]</span><span class="token" style="color:#c5c8c6">)</span>
      <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">usingConnection</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span>
<span class="token spread" style="color:#EDEDED">...</span></code></pre><h1>Rule: never reference <code>exits</code> from within <code>transaction(...)</code></h1><h2>Example: <code>exits.success()</code></h2><h3>Bad code</h3><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  <span class="token function-variable" style="color:#DAD085">fn</span><span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">inputs<span class="token" style="color:#c5c8c6">,</span> exits</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token" style="color:#96CBFE">await</span> sails
      <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">getDatastore</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span>
      <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">transaction</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#96CBFE">async</span> <span class="token parameter">db</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#c5c8c6">{</span>
        <span class="token" style="color:#DAD085">doSomeTransactionalStuff</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
        <span class="token" style="color:#96CBFE">return</span> exits<span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">success</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
      <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span></code></pre><h3>Good code</h3><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  <span class="token function-variable" style="color:#DAD085">fn</span><span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">inputs<span class="token" style="color:#c5c8c6">,</span> exits</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token" style="color:#96CBFE">await</span> sails
      <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">getDatastore</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span>
      <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">transaction</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#96CBFE">async</span> <span class="token parameter">db</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#c5c8c6">{</span>
        <span class="token" style="color:#DAD085">doSomeTransactionalStuff</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
      <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>

    <span class="token" style="color:#96CBFE">return</span> exits<span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">success</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span></code></pre><h3>Explanation</h3><p>When <code>exits.success()</code> is called, the HTTP Status code <code>200</code> is written to the response stream.  After this has been written, it cannot be changed to an error code.  However, in the first example, <code>exits.success()</code> is called <em>before the transaction has been committed to the database</em>.  This means that although there were no <code>Error</code>s thrown by <code>doSomeTransactionalStuff()</code>, there is still a chance that the transaction commit could fail in PostgreSQL.  Some reasons this could fail include:</p><ul><li>violation of a database-level constraint, e.g.uniqueness</li><li>failure/timeout of the db connection</li></ul><p>Because <code>exits.success()</code> has already been called, there is no way to notify the client that there was a problem committing the transaction.</p><p>More insidious, if the transaction <em>succeeds</em>, a race condition is introduced: the client may process the 200 response before the database write has completed.  We&#x27;ve seen integration tests fail intermittently because of this.</p><p>Therefore, any call to <code>exits.*()</code> or <code>this.res.status(...)</code> must be made <em>after</em> a transaction has been committed.</p><p>If the transaction fails, an <code>Error</code> will be thrown.  In the first example, this will provoke sails to report:</p><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#99CC99">WARNING</span><span class="token" style="color:#c5c8c6">:</span> <span class="token maybe-class-name">Something</span> seems to be wrong <span class="token" style="color:#96CBFE">with</span> <span class="token" style="color:#96CBFE">this</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">.</span>
<span class="token property-access"><span class="token maybe-class-name">It</span></span> is trying to signal that it has finished <span class="token" style="color:#99CC99">AGAIN</span><span class="token" style="color:#c5c8c6">,</span> after
already resolving<span class="token" style="color:#EDEDED">/</span>rejecting once<span class="token" style="color:#c5c8c6">.</span>
<span class="token" style="color:#c5c8c6">(</span>silently ignoring <span class="token" style="color:#96CBFE">this</span><span class="token spread" style="color:#EDEDED">...</span><span class="token" style="color:#c5c8c6">)</span></code></pre><p>In the good code above, the <code>Error</code> will be thrown <em>before</em> the call to <code>exits.success()</code>, and a <code>500</code> error returned to the client.</p><h2>Example: <code>exits.myError()</code></h2><h3>Bad code</h3><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  exits<span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#c5c8c6">{</span>
    myError<span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#c5c8c6">{</span> statusCode<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#FF73FD">500</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
  <span class="token function-variable" style="color:#DAD085">fn</span><span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">inputs<span class="token" style="color:#c5c8c6">,</span> exits</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token" style="color:#96CBFE">await</span> sails
      <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">getDatastore</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span>
      <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">transaction</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#96CBFE">async</span> <span class="token parameter">db</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#c5c8c6">{</span>
        <span class="token" style="color:#96CBFE">await</span> <span class="token maybe-class-name">Thing</span>
            <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">update</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">{</span> some_property<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#A8FF60">&#x27;some_value&#x27;</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span>
            <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">set</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">{</span> other_property<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#99CC99">false</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>

        <span class="token" style="color:#96CBFE">const</span> ok <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#96CBFE">await</span> <span class="token" style="color:#DAD085">isSomeConstraintSatisfied</span><span class="token" style="color:#c5c8c6">(</span>inputs<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
        <span class="token" style="color:#96CBFE">if</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#EDEDED">!</span>ok<span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
          <span class="token" style="color:#96CBFE">return</span> exits<span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">myError</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
        <span class="token" style="color:#c5c8c6">}</span>
      <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>

    <span class="token" style="color:#96CBFE">return</span> exits<span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">success</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span></code></pre><h3>Good code</h3><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  exits<span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#c5c8c6">{</span>
    myError<span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#c5c8c6">{</span> statusCode<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#FF73FD">500</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
  <span class="token function-variable" style="color:#DAD085">fn</span><span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">inputs<span class="token" style="color:#c5c8c6">,</span> exits</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token" style="color:#96CBFE">try</span> <span class="token" style="color:#c5c8c6">{</span>
      <span class="token" style="color:#96CBFE">await</span> sails
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">getDatastore</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span>
        <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">transaction</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#96CBFE">async</span> <span class="token parameter">db</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#c5c8c6">{</span>
          <span class="token" style="color:#96CBFE">await</span> <span class="token maybe-class-name">Thing</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">update</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">{</span> some_property<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#A8FF60">&#x27;some_value&#x27;</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span>
              <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">set</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">{</span> other_property<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#99CC99">false</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>

          <span class="token" style="color:#96CBFE">const</span> ok <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#96CBFE">await</span> <span class="token" style="color:#DAD085">isSomeConstraintSatisfied</span><span class="token" style="color:#c5c8c6">(</span>inputs<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
          <span class="token" style="color:#96CBFE">if</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#EDEDED">!</span>ok<span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
            <span class="token" style="color:#96CBFE">throw</span> <span class="token" style="color:#96CBFE">new</span> <span class="token" style="color:#FFFFB6;text-decoration:underline">Error</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
          <span class="token" style="color:#c5c8c6">}</span>
        <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>

      <span class="token" style="color:#96CBFE">return</span> exits<span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">success</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
    <span class="token" style="color:#c5c8c6">}</span> <span class="token" style="color:#96CBFE">catch</span><span class="token" style="color:#c5c8c6">(</span>e<span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
      <span class="token" style="color:#96CBFE">return</span> exits<span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">myError</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
    <span class="token" style="color:#c5c8c6">}</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span></code></pre><h3>Explanation</h3><p>There are two problems in the bad code above - the <code>return</code> within the transaction:</p><ol><li>actually returns to the parent <code>fn</code>, which then continues executing.  Therefore both <code>exits.myError()</code> <em>and</em> <code>exits.success()</code> are called.</li><li>allows the transaction to complete cleanly, and therefore <code>waterline</code> will attempt to commit it to the database.  This means that, perhaps counterintuitively, if we return <code>exits.myError()</code>, the database update to <code>Thing</code> will still be committed to the database.</li></ol><p>In the second example, if <code>ok</code> is <code>false</code>, an <code>Error</code> is thrown.  This causes the transaction to be rolled back, before finally calling <code>exits.myError()</code>, which will return a status <code>500</code> to the client.</p><h1>Rule: <code>.intercept()</code> actually works!</h1><p>This surprised me, as it looks like it should also suffer from the two-writes bug described above (&quot;<code>It is trying to signal that it has finished AGAIN</code>&quot;):</p><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">module<span class="token" style="color:#c5c8c6">.</span><span class="token property-access">exports</span> <span class="token" style="color:#EDEDED">=</span> <span class="token" style="color:#c5c8c6">{</span>
  exits<span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#c5c8c6">{</span>
    badly<span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#c5c8c6">{</span> statusCode<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#FF73FD">567</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>

  <span class="token function-variable" style="color:#DAD085">fn</span><span class="token" style="color:#c5c8c6">:</span> <span class="token" style="color:#96CBFE">async</span> <span class="token" style="color:#96CBFE">function</span><span class="token" style="color:#c5c8c6">(</span><span class="token parameter">inputs<span class="token" style="color:#c5c8c6">,</span> exits</span><span class="token" style="color:#c5c8c6">)</span> <span class="token" style="color:#c5c8c6">{</span>
    <span class="token" style="color:#96CBFE">await</span> sails
      <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">getDatastore</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span>
      <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">transaction</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#96CBFE">async</span> <span class="token parameter">db</span> <span class="token arrow" style="color:#EDEDED">=&gt;</span> <span class="token" style="color:#c5c8c6">{</span>
        <span class="token" style="color:#96CBFE">await</span> <span class="token maybe-class-name">Thing</span>
            <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">create</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">{</span> id<span class="token" style="color:#c5c8c6">:</span><span class="token" style="color:#FF73FD">1</span> <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span>
            <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">intercept</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#A8FF60">&#x27;E_UNIQUE&#x27;</span><span class="token" style="color:#c5c8c6">,</span> <span class="token" style="color:#A8FF60">&#x27;badly&#x27;</span><span class="token" style="color:#c5c8c6">)</span>
            <span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">usingConnection</span><span class="token" style="color:#c5c8c6">(</span>db<span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
      <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>

    <span class="token" style="color:#96CBFE">return</span> exits<span class="token" style="color:#c5c8c6">.</span><span class="token method property-access" style="color:#DAD085">success</span><span class="token" style="color:#c5c8c6">(</span><span class="token" style="color:#c5c8c6">)</span><span class="token" style="color:#c5c8c6">;</span>
  <span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">,</span>
<span class="token" style="color:#c5c8c6">}</span><span class="token" style="color:#c5c8c6">;</span></code></pre><p>As intended, although perhaps not expected, this will return an HTTP status code of <code>567</code>, <em>without</em> logging a <code>WARNING</code> 🤔</p><hr/><h1>Conclusion</h1><p>Transactions are important, but complicated.  <code>exits</code> are complicated, but perhaps not important.  🤷</p></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-140905521-1', 'auto', {});
      
      
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/2019-06-20-sailsjs-transactions-and-exits/";window.webpackCompilationHash="de8a87b2ebac54622da8";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-5befd302e65070181bb9.js"],"component---src-pages-blog-2019-06-20-sailsjs-transactions-and-exits-index-js":["/component---src-pages-blog-2019-06-20-sailsjs-transactions-and-exits-index-js-c91935e46dbb871528ba.js"],"component---src-pages-blog-index-js":["/component---src-pages-blog-index-js-add0007fd552d5c28e02.js"],"component---src-pages-index-js":["/component---src-pages-index-js-14436220371d104bd88f.js"],"component---src-pages-jobs-js":["/component---src-pages-jobs-js-886580b25f9375680477.js"]};/*]]>*/</script><script src="/webpack-runtime-f54bed28e5bbff5d5cd5.js" async=""></script><script src="/app-5befd302e65070181bb9.js" async=""></script><script src="/1-ba61c470b01978e180bc.js" async=""></script><script src="/2-3bf0ec90dbd38abd1022.js" async=""></script><script src="/component---src-pages-blog-2019-06-20-sailsjs-transactions-and-exits-index-js-c91935e46dbb871528ba.js" async=""></script><script src="/styles-f907142474616c65419d.js" async=""></script></body></html>